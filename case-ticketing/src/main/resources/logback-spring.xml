<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <include resource="org/springframework/boot/logging/logback/defaults.xml"/>
    <springProperty scope="context" name="APP_NAME" source="spring.application.name" defaultValue="unknown-service"/>

    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%clr(%d{yyyy-MM-dd HH:mm:ss.SSS,Asia/Seoul}){faint} %clr(%-5level) %clr([%thread]){faint} %clr(%logger{36}){cyan} - %clr([%X{traceId:-}/%X{spanId:-}]){magenta} %clr([%X{correlationId:-}]){yellow} %clr([%X{httpMethod:-} %X{requestUri:-}]){green} %msg%n%ex</pattern>
        </encoder>
    </appender>

    <logger name="org.springframework" level="INFO"/>
    <logger name="org.hibernate" level="WARN"/>

    <springProfile name="local">
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
        </root>
    </springProfile>

    <springProfile name="!local">
        <appender name="CONSOLE_JSON" class="ch.qos.logback.core.ConsoleAppender">
            <encoder class="net.logstash.logback.encoder.LoggingEventCompositeJsonEncoder">
                <providers>
                    <timestamp>
                        <fieldName>@timestamp</fieldName>
                        <pattern>yyyy-MM-dd'T'HH:mm:ss.SSSXXX</pattern>
                        <timeZone>Asia/Seoul</timeZone>
                    </timestamp>
                    <pattern>
                        <pattern>
                            {
                            "service":"${APP_NAME}",
                            "level":"%level",
                            "logger":"%logger{36}",
                            "thread":"%thread",
                            "traceId":"%X{traceId:-}",
                            "spanId":"%X{spanId:-}",
                            "correlationId":"%X{correlationId:-}",
                            "httpMethod":"%X{httpMethod:-}",
                            "requestUri":"%X{requestUri:-}",
                            "message":"%message"
                            }
                        </pattern>
                    </pattern>
                    <stackTrace>
                        <fieldName>stacktrace</fieldName>
                    </stackTrace>
                </providers>
            </encoder>
        </appender>
        <root level="INFO">
            <appender-ref ref="CONSOLE_JSON"/>
        </root>
    </springProfile>
</configuration>

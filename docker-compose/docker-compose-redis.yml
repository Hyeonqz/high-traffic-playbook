name: high-traffic-infra
version: '3.8'

services:
  # ============================================
  # Redis Master (읽기/쓰기)
  # ============================================
  redis-master:
    image: redis:latest
    hostname: redis-master
    container_name: redis-master
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: >
      redis-server
      --maxmemory 4gb
      --maxmemory-policy allkeys-lru
      --save 60 1000
      --appendonly yes
      --appendfsync everysec
    volumes:
      - redis-master-data:/data
    networks:
      - high-traffic-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ============================================
  # Redis Slave (읽기 전용 복제본)
  # ============================================
  redis-slave:
    image: redis:latest
    hostname: redis-slave
    container_name: redis-slave
    restart: unless-stopped
    ports:
      - "6380:6379"
    command: >
      redis-server
      --replicaof redis-master 6379
      --replica-read-only yes
      --replica-announce-ip 127.0.0.1
      --replica-announce-port 6380
      --maxmemory 4gb
      --maxmemory-policy allkeys-lru
    volumes:
      - redis-slave-data:/data
    networks:
      - high-traffic-network
    depends_on:
      - redis-master
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ============================================
  # Redis Sentinel (자동 Failover)
  # ============================================
  redis-sentinel:
    image: redis:latest
    hostname: redis-sentinel
    container_name: redis-sentinel
    restart: unless-stopped
    ports:
      - "26379:26379"
    entrypoint: ["/bin/sh", "/sentinel-entrypoint.sh"]
    volumes:
      - ./sentinel-entrypoint.sh:/sentinel-entrypoint.sh:ro
      - redis-sentinel-data:/data
    networks:
      - high-traffic-network
    depends_on:
      redis-master:
        condition: service_healthy
      redis-slave:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "26379", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

networks:
  high-traffic-network:
    name: high-traffic-network
    driver: bridge
    external: true

volumes:
  redis-master-data:
    driver: local
  redis-slave-data:
    driver: local
  redis-sentinel-data:
    driver: local
